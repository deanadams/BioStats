anova(ols.fit)
# GLS models with different spatial autocorrelations
# Warning!  False convergeneces possible
t <- as.factor(t)
geo=data.frame(g,t,y)
gls.fit.exp = gls(y~t, data=geo, correlation=corExp(form=~lat+long)) #exponential
gls.fit.gaus = gls(y~t, data=geo,  correlation=corGaus(form=~lat+long)) #gaussian
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
gls.fit.lin = gls(y~t, data=geo,  correlation=corLin(form=~lat+long)) #linear
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
gls.fit.lin
gls.fit.lin = gls(y~t, data=geo,  correlation=corLin(form=~lat+long)) #linear
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
?corLin
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus,gls.fit.lin) #Careful when y is multivariate, see Model Selection lecture
## BLOWS UP HERE
gls.fit.lin = gls(y~t, data=geo,  correlation=corLin(form=~lat+long)) #linear
?vgm
?variogram
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus) #Careful when y is multivariate, see Model Selection lecture
## Exponential decay of spatial dependence is best model
# Anova
anova(gls.fit.exp)
anova(gls.fit.gaus)
anova(gls.fit.spher)
#  One could estimate spatial covariance matrix from distances via Gower's approach
spatCov <- function(x){
x <- as.matrix(x)
if(ncol(x) != 2) stop("Need two columns for lat long!")
d <- dist(x)
P <- cmdscale(d, 2)
tcrossprod(P)/(ncol(P) - 1)
}
#example
spat.cov<-spatCov(g)
rdf <- rrpp.data.frame(g=g, y=y,t=t, spat.cov = spat.cov)
res <- lm.rrpp(y~t,Cov = spat.cov, data = rdf)
anova(res)
#example
spat.cov<-spatCov(g)
rdf <- rrpp.data.frame(g=g, y=y,t=t, spat.cov = spat.cov)
res <- lm.rrpp(y~t,Cov = spat.cov, data = rdf)
spat.cov
class(spat.cov)
mycor <- corMatrix(Initialize(corExp(1,form = ~lat+long),data=geo))
anova(lm.rrpp(y~t,Cov = mycor, data = geo))
gstat:::variogram
install.packages("gstat")
library(gstat)
#3b: Semivarigram
res <- variogram(y)
library(spatstat)
library(RRPP)
library(vegan)
library(spdep)
library(gstat)
plot(cells)
plot(Kest(cells))   #shows K for various models: isotropic, poisson, etc.
E<-envelope(cells,Kest,nsim=100,rank=2)
plot(E) # plot shows that observed are underdispersed at small spatial scales
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
sc <- 0.0   #spatial contingency: 0->1
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
moran.test(y,nb2listw(W))   #positive autocorrelation
#1: Ripley's K
data(cells)
# Generate Spatially Autocorrelated Data  (one could also read some in!)
lat<-runif(50,0,5); long<-runif(50,0,5)
# Valuee is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
?variogram
y
# Generate Spatially Autocorrelated Data  (one could also read some in!)
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
moran.test(y,nb2listw(W))   #positive autocorrelation
g
y
data(meuse)
meuse
coordinates(meuse) = ~x+y
meuse
data(meuse)
class(meuse)
g
g$lat
dim(g)
#3b: Semivarigram
df <- data.frame(g,y)
coordinates(df) <- ~g[,1]+g[,2]
coordinates(df) = ~g
res <- variogram(y,df)
res <- variogram(y~1,df)
res
plot(res)
plot(res, type="l")
plot(res, type = "b", main = "Variogram: y")
VarMdl <- vgm(psill=0.15, model="Gau", nugget=0.0001, range=5)
plot(res, model=VarMdl)
?vgm
VarMdl <- vgm(psill=res, model="Gau", nugget=0.0001, range=5)
VarMdl <- vgm(psill=2, model="Gau", nugget=0.0001, range=5)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=5)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=25)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=.2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=3, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=2.5, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
plot(res, type = "b", main = "Variogram: y")
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
library(spatstat)
library(RRPP)
library(vegan)
library(spdep)
library(gstat)
#1: Ripley's K
data(cells)
plot(cells)
plot(Kest(cells))   #shows K for various models: isotropic, poisson, etc.
E<-envelope(cells,Kest,nsim=100,rank=2)
plot(E) # plot shows that observed are underdispersed at small spatial scales
# Generate Spatially Autocorrelated Data  (one could also read some in!)
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
moran.test(y,nb2listw(W))   #positive autocorrelation
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
#3b: Semivarigram
df <- data.frame(g,y)
coordinates(df) = ~g
res <- variogram(y~1,df)
plot(res, type = "b", main = "Variogram: y")
#Plot vs. Gaussian model
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
#4: Account for Spatial Non-Independence
ols.fit <- lm(y~t, x=T)  #spatial proximity not considered
summary(ols.fit)
anova(ols.fit)
# GLS models with different spatial autocorrelation structure
# Warning!  False convergences possible
t <- as.factor(t)
geo=data.frame(g,t,y)
gls.fit.exp = gls(y~t, data=geo, correlation=corExp(form=~lat+long)) #exponential
gls.fit.gaus = gls(y~t, data=geo,  correlation=corGaus(form=~lat+long)) #gaussian
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus) #Careful when y is multivariate, see Model Selection lecture
## Exponential decay of spatial dependence is best model
# Anova
anova(gls.fit.exp)
anova(gls.fit.gaus)
anova(gls.fit.spher)
#  One could estimate spatial covariance matrix from distances via Gower's approach
spatCov <- function(x){
x <- as.matrix(x)
if(ncol(x) != 2) stop("Need two columns for lat long!")
d <- dist(x)
P <- cmdscale(d, 2)
tcrossprod(P)/(ncol(P) - 1)
}
############ DOESN'T WORK
#example:  DOESN"T WORK
spat.cov<-spatCov(g)
rdf <- rrpp.data.frame(g=g, y=y,t=t, spat.cov = spat.cov)
res <- lm.rrpp(y~t,Cov = spat.cov, data = rdf)
anova(res)
rdf <- rrpp.data.frame(g=g, y=y,t=t, spat.cov = spat.cov)
res <- lm.rrpp(y~t,Cov = spat.cov, data = rdf)
anova(res)
mycor <- corMatrix(Initialize(corExp(1,form = ~lat+long),data=geo))
anova(lm.rrpp(y~t,Cov = mycor, data = geo))
# Generate Spatially Autocorrelated Data  (one could also read some in!)
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
moran.test(y,nb2listw(W))   #positive autocorrelation
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
#3b: Semivarigram
df <- data.frame(g,y)
coordinates(df) = ~g
res <- variogram(y~1,df)
plot(res, type = "b", main = "Variogram: y")
#Plot vs. Gaussian model
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
#4: Account for Spatial Non-Independence
ols.fit <- lm(y~t, x=T)  #spatial proximity not considered
summary(ols.fit)
anova(ols.fit)
# GLS models with different spatial autocorrelation structure
# Warning!  False convergences possible
t <- as.factor(t)
geo=data.frame(g,t,y)
gls.fit.exp = gls(y~t, data=geo, correlation=corExp(form=~lat+long)) #exponential
gls.fit.gaus = gls(y~t, data=geo,  correlation=corGaus(form=~lat+long)) #gaussian
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus) #Careful when y is multivariate, see Model Selection lecture
# Generate Spatially Autocorrelated Data  (one could also read some in!)
set.seed(234)
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
moran.test(y,nb2listw(W))   #positive autocorrelation
coordinates(df) = ~g
res <- variogram(y~1,df)
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
#3b: Semivarigram
df <- data.frame(g,y)
plot(res, type = "b", main = "Variogram: y")
#Plot vs. Gaussian model
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
#1: Ripley's K
data(cells)
plot(cells)
plot(Kest(cells))   #shows K for various models: isotropic, poisson, etc.
E<-envelope(cells,Kest,nsim=100,rank=2)
plot(E) # plot shows that observed are underdispersed at small spatial scales
# Generate Spatially Autocorrelated Data  (one could also read some in!)
set.seed(234)
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
moran.test(y,nb2listw(W))   #positive autocorrelation
#3b: Semivarigram
df <- data.frame(g,y)
coordinates(df) = ~g
res <- variogram(y~1,df)
plot(res, type = "b", main = "Variogram: y")
#Plot vs. Gaussian model
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
#4: Account for Spatial Non-Independence
ols.fit <- lm(y~t, x=T)  #spatial proximity not considered
summary(ols.fit)
anova(ols.fit)
# GLS models with different spatial autocorrelation structure
# Warning!  False convergences possible
t <- as.factor(t)
geo=data.frame(g,t,y)
gls.fit.exp = gls(y~t, data=geo, correlation=corExp(form=~lat+long)) #exponential
gls.fit.gaus = gls(y~t, data=geo,  correlation=corGaus(form=~lat+long)) #gaussian
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
gls.fit.lin = gls(y~t, data=geo,  correlation=corLin(form=~lat+long))
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
gls.fit.lin
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus, gls.fit.lin) #Careful when y is multivariate, see Model Selection lecture
anova(gls.fit.lin)
# Generate Spatially Autocorrelated Data  (one could also read some in!)
set.seed(234)
lat<-runif(50,0,5); long<-runif(50,0,5)
lat
long
# Generate Spatially Autocorrelated Data  (one could also read some in!)
set.seed(234)
lat<-runif(50,0,5); long<-runif(50,0,5)
lat
long
# Generate Spatially Autocorrelated Data  (one could also read some in!)
set.seed(2345)
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
moran.test(y,nb2listw(W))   #positive autocorrelation
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
#3b: Semivarigram
df <- data.frame(g,y)
coordinates(df) = ~g
res <- variogram(y~1,df)
plot(res, type = "b", main = "Variogram: y")
#Plot vs. Gaussian model
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
#4: Account for Spatial Non-Independence
ols.fit <- lm(y~t, x=T)  #spatial proximity not considered
summary(ols.fit)
anova(ols.fit)
# GLS models with different spatial autocorrelation structure
# Warning!  False convergences possible
t <- as.factor(t)
geo=data.frame(g,t,y)
gls.fit.exp = gls(y~t, data=geo, correlation=corExp(form=~lat+long)) #exponential
gls.fit.gaus = gls(y~t, data=geo,  correlation=corGaus(form=~lat+long)) #gaussian
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
gls.fit.lin = gls(y~t, data=geo,  correlation=corLin(form=~lat+long))
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
gls.fit.lin
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus, gls.fit.lin) #Careful when y is multivariate, see Model Selection lecture
lat<-runif(50,0,5); long<-runif(50,0,5)
g<-cbind(lat,long)  #create an XY spatial grid
y <- sqrt(diag(g%*%t(g))) + rnorm(nrow(g))  #a spatially-autocorrelated variable
# Value is associated with distance from origin
t <- sample(rep(c(1,2),length(y)/2))  #2 ecological 'groups' constrained by spatial contingency
sc <- 0.0   #spatial contingency: 0->1
for(i in 1:length(y)){
z = scale(y,scale=sd(y))
crit = 1-sc
crit =c(-crit/2,crit/2)*3
if(z[i]<=min(crit)) t[i]=1
if(z[i]>=max(crit)) t[i]=2
}
plot(g, pch=21, bg=t, cex=y, asp=1, main="Species diversity proprotional to circle size
Color designates ecological type")
#2: Covariation of Geography and Data
mantel(dist(g), dist(y), permutations = 9999)  # Mantel association
mantel.partial(dist(t), dist(y), dist(g), permutations = 9999)  #3-way Mantel holding group constant
moran.test(y,nb2listw(W))   #positive autocorrelation
#3: Spatial Autocorrelation
W<-tri2nb(g) #weights with Delauney tesselation
#3b: Semivarigram
df <- data.frame(g,y)
coordinates(df) = ~g
res <- variogram(y~1,df)
plot(res, type = "b", main = "Variogram: y")
#Plot vs. Gaussian model
VarMdl <- vgm(psill=2, model="Gau", nugget=0.1, range=1)
plot(res, model=VarMdl)
#4: Account for Spatial Non-Independence
ols.fit <- lm(y~t, x=T)  #spatial proximity not considered
summary(ols.fit)
anova(ols.fit)
# GLS models with different spatial autocorrelation structure
# Warning!  False convergences possible
t <- as.factor(t)
geo=data.frame(g,t,y)
gls.fit.exp = gls(y~t, data=geo, correlation=corExp(form=~lat+long)) #exponential
gls.fit.gaus = gls(y~t, data=geo,  correlation=corGaus(form=~lat+long)) #gaussian
gls.fit.spher = gls(y~t, data=geo,  correlation=corSpher(form=~lat+long)) #spherical
gls.fit.lin = gls(y~t, data=geo,  correlation=corLin(form=~lat+long))
# look at coeffcients: VERY DIFFERENT when spatial non-independence considered
ols.fit
gls.fit.exp
gls.fit.gaus
gls.fit.spher
gls.fit.lin
# model comparisons
AIC(gls.fit.exp, gls.fit.gaus, gls.fit.lin) #Careful when y is multivariate, see Model Selection lecture
## Exponential decay of spatial dependence is best model
# Anova
anova(gls.fit.exp)
anova(gls.fit.gaus)
anova(gls.fit.spher)
anova(gls.fit.lin)
#  One could estimate spatial covariance matrix from distances via Gower's approach
spatCov <- function(x){
x <- as.matrix(x)
if(ncol(x) != 2) stop("Need two columns for lat long!")
d <- dist(x)
P <- cmdscale(d, 2)
tcrossprod(P)/(ncol(P) - 1)
}
spat.cov<-spatCov(g)
rdf <- rrpp.data.frame(g=g, y=y,t=t, spat.cov = spat.cov)
res <- lm.rrpp(y~t,Cov = spat.cov, data = rdf)
anova(res)
mycor <- corMatrix(Initialize(corExp(1,form = ~lat+long),data=geo))
anova(lm.rrpp(y~t,Cov = mycor, data = geo))
